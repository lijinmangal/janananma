{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}

<div class="container mt-5">
  <h2 class="mb-4 text-center">Manager Daily Finance Entry</h2>
  <form method="POST">
    {% csrf_token %}

    <!-- Income Section -->
    <div class="card mb-4">
      <div class="card-header bg-success text-white">Income</div>
      <div class="card-body row g-3">
        
        <div class="col-md-4">
          <label>Previous Day Cash Balance (Auto)</label>
          <input type="number" step="0.01" name="previous_balance" id="previous_balance" value="{{ previous_day_balance }}" class="form-control" readonly>
        </div>

        <div class="col-md-4">
          <label>Additional Cash in Hand</label>
          <input type="number" step="0.01" name="extra_cash" id="extra_cash" value="0" class="form-control">
        </div>

        <div class="col-md-4">
          <label>Today's Sale</label>
          <input type="number" step="0.01" name="sale_of_day" class="form-control" id="sale_of_day" value="0" class="form-control">
        </div>

        {% for person in staff_members %}
        <div class="col-md-4">
          <label>Credit Paid by {{ person }}</label>
          <input type="number" step="0.01" name="credit_paid_{{ person|lower }}" class="form-control">
        </div>
        {% endfor %}

        <div class="col-md-4">
          <label>Rajeev/Bakery Income</label>
          <input type="number" step="0.01" name="raajeev_income" class="form-control">
        </div>

        <div class="col-md-4">
          <label>From Black Purse</label>
          <input type="number" step="0.01" name="black_purse" class="form-control">
        </div>

        <div class="col-md-4">
          <label>Money From Bank</label>
          <input type="number" step="0.01" name="money_from_bank" class="form-control">
        </div>

        <div class="col-md-4">
          <label>Other Income (Specify)</label>
          <input type="text" name="other_income_spec" class="form-control">
        </div>

        <div class="col-md-4">
          <label>Other Income (Amount)</label>
          <input type="number" step="0.01" name="other_income" class="form-control">
        </div>

      </div>
    </div>

    <!-- Expenditure Section -->
    <div class="card mb-4">
      <div class="card-header bg-danger text-white">Expenditure</div>
      <div class="card-body row g-3">

        <div class="col-md-4">
          <label>SIP Paid</label>
          <input type="number" step="0.01" name="sip" class="form-control">
        </div>

        <div class="col-md-4">
          <label>Gokulam Paid</label>
          <input type="number" step="0.01" name="gokulam" class="form-control">
        </div>

        <div class="col-md-4">
          <label>Chitty/Vijesh Paid</label>
          <input type="number" step="0.01" name="vijesh" class="form-control">
        </div>

        <div class="col-md-4">
          <label>Rajeev/Bakery Expenditure</label>
          <input type="number" step="0.01" name="raajeev_expenditure" class="form-control">
        </div>

        {% for person in credit_names %}
        <div class="col-md-4">
          <label>Salary Paid - {{ person }}</label>
          <input type="number" step="0.01" name="salary_{{ person|lower }}" class="form-control">
        </div>
        {% endfor %}

        {% for person in credit_names %}
        <div class="col-md-4">
          <label>Credit Given to - {{ person }}</label>
          <input type="number" step="0.01" name="credit_to_{{ person|lower }}" class="form-control">
        </div>
        {% endfor %}

        <div class="col-md-4">
          <label>Customer Credit Received</label>
          <input type="number" step="0.01" name="customer_credit" class="form-control">
        </div>

        <div class="col-md-4">
          <label>Other Expenditure (Specify)</label>
          <input type="text" name="other_expenditure_spec" class="form-control">
        </div>

        <div class="col-md-4">
          <label>Other Expenditure (Amount)</label>
          <input type="number" step="0.01" name="other_expenditure" class="form-control">
        </div>

        <div class="col-md-4">
          <label>Medicine Purchase</label>
          <input type="number" step="0.01" name="medicine_purchase" class="form-control">
        </div>

        <div class="col-md-4">
          <label>GPay to Bank</label>
          <input type="number" step="0.01" name="gpay_to_bank" class="form-control">
        </div>

      </div>
    </div>

    <!-- Bank Transaction Section -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">Bank Transactions</div>
      <div class="card-body">
        
        <table class="table table-bordered" id="bankTransactionTable">
          <thead>
            <tr>
              <th>Type</th>
              <th>Amount (₹)</th>
              <th>Description</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="bankTransactionBody">
            <tr>
              <td>
                <select name="transaction_type" class="form-select">
                  <option value="Income">Income</option>
                  <option value="Expenditure">Expenditure</option>
                </select>
              </td>
              <td><input type="number" step="0.01" name="amount" class="form-control" required></td>
              <td><input type="text" name="description" class="form-control" required></td>
              <td class="text-center">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeTransactionRow(this)">Remove</button>
              </td>
            </tr>
          </tbody>
        </table>

        <button type="button" class="btn btn-secondary" onclick="addTransactionRow()">Add Another Transaction</button>

        <div class="row mt-4">
          <div class="col-md-4">
            <label>Total Bank Income (₹)</label>
            <input type="number" id="totalBankIncome" class="form-control" readonly>
          </div>
          <div class="col-md-4">
            <label>Total Bank Expenditure (₹)</label>
            <input type="number" id="totalBankExpenditure" class="form-control" readonly>
          </div>
          <div class="col-md-4">
            <label>Bank Closing Balance (₹)</label>
            <input type="number" id="bankClosingBalance" class="form-control" readonly>
          </div>
        </div>

      </div>
    </div>

    <!-- Credit Details Section -->
    <div class="card mb-4">
      <div class="card-header bg-warning text-dark">Credit Details</div>
      <div class="card-body">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Person</th>
              <th>Previous Credit</th>
              <th>Today's Credit</th>
            </tr>
          </thead>
          <tbody>
            {% for person in credit_names %}
            <tr>
              <td>{{ person }}</td>
              <td>{{ previous_credit|get_item:person }}</td>
              <td>
                <input type="number" step="0.01" name="credit_given_{{ person|lower }}" class="form-control">
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Summary Section -->
    <div class="card mb-4">
      <div class="card-header bg-info text-white">Summary</div>
      <div class="card-body row g-3">
        <div class="col-md-4">
          <label>Total Income (Auto)</label>
          <input type="number" step="0.01" name="total_income" class="form-control" readonly>
        </div>
        <div class="col-md-4">
          <label>Total Expenditure (Auto)</label>
          <input type="number" step="0.01" name="total_expenditure" class="form-control" readonly>
        </div>
        <div class="col-md-4">
          <label>Cash Closing Balance</label>
          <input type="number" step="0.01" name="cash_balance" class="form-control" readonly>
        </div>
      </div>
    </div>

    <div class="text-center">
      <button type="submit" id="submitBtn" class="btn btn-primary mt-3">Submit Daily Entry</button>
    </div>

  </form>
</div>


{% block scripts %}
<script>
// --- 1. Add/Remove Bank Transaction Row ---

function addTransactionRow() {
    const table = document.getElementById("bankTransactionBody");
    const newRow = `
        <tr>
          <td>
            <select name="transaction_type" class="form-select">
              <option value="Income">Income</option>
              <option value="Expenditure">Expenditure</option>
            </select>
          </td>
          <td><input type="number" step="0.01" name="amount" class="form-control" required></td>
          <td><input type="text" name="description" class="form-control" required></td>
          <td class="text-center">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeTransactionRow(this)">Remove</button>
          </td>
        </tr>
    `;
    table.insertAdjacentHTML('beforeend', newRow);
}

function removeTransactionRow(button) {
    button.closest('tr').remove();
}

// --- 2. Calculate Bank Summary (Live) ---

function calculateBankSummary() {
    let incomeTotal = 0;
    let expenditureTotal = 0;

    const rows = document.querySelectorAll('#bankTransactionBody tr');
    rows.forEach(function(row) {
        const type = row.querySelector('select[name="transaction_type"]')?.value;
        const amount = parseFloat(row.querySelector('input[name="amount"]')?.value) || 0;

        if (type === "Income") {
            incomeTotal += amount;
        } else if (type === "Expenditure") {
            expenditureTotal += amount;
        }
    });

    document.getElementById('totalBankIncome').value = incomeTotal.toFixed(2);
    document.getElementById('totalBankExpenditure').value = expenditureTotal.toFixed(2);
    document.getElementById('bankClosingBalance').value = (incomeTotal - expenditureTotal).toFixed(2);
}

// --- 3. Calculate Total Income, Expenditure, Cash Balance ---

function calculateTotals() {
    const previousCash = parseFloat(document.getElementById('previous_balance')?.value) || 0;
    const extraCash = parseFloat(document.getElementById('extra_cash')?.value) || 0;

    // Income Fields
    const incomeFields = [
        'sale_of_day', 'other_income', 'money_from_bank', 'black_purse', 'raajeev_income',
        'credit_paid_amila', 'credit_paid_ashwati', 'credit_paid_athira', 'credit_paid_arun',
        'credit_paid_lijin', 'credit_paid_kannan'
    ];
    let totalIncome = previousCash + extraCash;

    incomeFields.forEach(function(name) {
        const input = document.getElementsByName(name)[0];
        if (input && input.value) {
            totalIncome += parseFloat(input.value) || 0;
        }
    });

    // Expenditure Fields
    const expenditureFields = [
        'sip', 'gokulam', 'vijesh', 'raajeev_expenditure',
        'salary_amila', 'salary_ashwati', 'salary_athira', 'salary_arun',
        'salary_lijin', 'salary_kannan',
        'credit_to_amila', 'credit_to_ashwati', 'credit_to_athira', 'credit_to_arun',
        'credit_to_lijin', 'credit_to_kannan',
        'customer_credit', 'other_expenditure', 'medicine_purchase', 'gpay_to_bank'
    ];
    let totalExpenditure = 0;

    expenditureFields.forEach(function(name) {
        const input = document.getElementsByName(name)[0];
        if (input && input.value) {
            totalExpenditure += parseFloat(input.value) || 0;
        }
    });

    // Calculate Cash Closing
    const cashBalance = totalIncome - totalExpenditure;

    if (document.getElementsByName('total_income')[0]) {
        document.getElementsByName('total_income')[0].value = totalIncome.toFixed(2);
    }
    if (document.getElementsByName('total_expenditure')[0]) {
        document.getElementsByName('total_expenditure')[0].value = totalExpenditure.toFixed(2);
    }
    if (document.getElementsByName('cash_balance')[0]) {
        document.getElementsByName('cash_balance')[0].value = cashBalance.toFixed(2);
    }
}

// --- 4. Auto Recalculate on Input Changes ---

document.addEventListener('DOMContentLoaded', function() {
    setInterval(function() {
        calculateBankSummary();
        calculateTotals();
    }, 500);  // every half second
});

</script>
{% endblock %}

  
      
{% endblock %}
