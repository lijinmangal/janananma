<!-- File: templates/dashboard/manager_daily_input.html -->
{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}
<div class="container mt-5">
  <h2 class="mb-4">Manager Daily Finance Entry</h2>
  <form method="POST">
    {% csrf_token %}

    <!-- Income Section -->
    <div class="card mb-4">
      <div class="card-header bg-success text-white">Income</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label>Previous Balance</label>
            <input type="number" step="0.01" name="previous_balance" placeholder="" class="form-control">
          </div>
          {% for person in staff_members %}
          <div class="col-md-4">
            <label>Credit Paid by {{ person }}</label>
            <input type="number" step="0.01" name="credit_paid_{{ person|lower }}" placeholder="" class="form-control">
          </div>
          {% endfor %}
          <div class="col-md-4">
            <label>Rajeev/Bakery Income</label>
            <input type="number" step="0.01" name="raajeev_income" placeholder="" class="form-control">
          </div>
          <div class="col-md-4">
            
            <label>From Black Purse</label>
            <input type="number" step="0.01" name="black_purse" placeholder="" class="form-control">
          </div>
          <div class="col-md-4">
            <label>Other Income Specification</label>
            <input type="text" name="other_income_spec" placeholder="" class="form-control">
          </div>
          <div class="col-md-4">
            <label>Other Income Amount</label>
            <input type="number" step="0.01" name="other_income" placeholder="" class="form-control">
          </div>
          <div class="col-md-4">
            <label>Bank Paid</label>
            <input type="number" step="0.01" name="bank_paid" placeholder="" class="form-control" value="{{ finance_entry.money_from_bank|default_if_none:"0" }}>
          </div>
          <div class="col-md-4">
            <label>Today's Sale</label>
            <input type="number" step="0.01" name="today_sale" placeholder="" class="form-control">
          </div>
        </div>
      </div>
    </div>

    <!-- Expenditure Section -->
    <div class="card mb-4">
      <div class="card-header bg-danger text-white">Expenditure</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label>Sip</label>
            <input type="number" step="0.01" name="sip" placeholder="" class="form-control">
          </div>
          <div class="col-md-4">
            <label>Gokulam</label>
            <input type="number" step="0.01" name="gokulam" placeholder="" class="form-control">
          </div>
          <div class="col-md-4">
            <label>Chitty/Vijesh</label>
            <input type="number" step="0.01" name="vijesh" placeholder="" class="form-control">
          </div>
          <div class="col-md-4">
            <label>Rajeev/Bakery Expenditure</label>
            <input type="number" step="0.01" name="raajeev_expenditure" placeholder="" class="form-control">
          </div>
          {% for person in credit_names %}
          <div class="col-md-4">
            <label>salary_{{ person|lower }}</label>
            <input type="number" step="0.01" name="salary_{{ person|lower }}" placeholder="" class="form-control">
          </div>
          {% endfor %}

          {% for person in credit_names %}
          <div class="col-md-4">
            <label>credit_to_{{ person|lower }}</label>
            <input type="number" step="0.01" name="credit_to_{{ person|lower }}" placeholder="" class="form-control">
          </div>
          {% endfor %}
          
          <div class="col-md-4">
            <label>Customer Credit</label>
            <input type="number" step="0.01" name="customer_credit" placeholder="" class="form-control">
          </div>
          <div class="col-md-4"> 
            <label>Other Expenditure Specification</label>
            <input type="text" name="other_expenditure_spec" placeholder="" class="form-control">
          </div>
          <div class="col-md-4"> 
            <label>Other Expenditure Amount</label>
            <input type="number" step="0.01" name="other_expenditure" placeholder="" class="form-control">
          </div>
          <div class="col-md-4"> 
            <label>Medicine Purchase</label>
            <input type="number" step="0.01" name="medicine_purchase" placeholder="" class="form-control">
          </div>
          <div class="col-md-4"> 
            <label>GPay to Bank</label>
            <input type="number" step="0.01" name="gpay_to_bank" placeholder="" class="form-control">
          </div>
        </div>
      </div>
    </div>

    <!-- Summary Section -->
    <div class="card mb-4">
      <div class="card-header bg-info text-white">Summary</div>
      <div class="card-body row g-3">
        <div class="col-md-4"><label>Total Income </label>
          <input type="number" step="0.01" name="total_income" placeholder="Total Income (Auto)" class="form-control" readonly>
        </div>
        <div class="col-md-4"><label>otal Expenditure </label>
          <input type="number" step="0.01" name="total_expenditure" placeholder="Total Expenditure (Auto)" class="form-control" readonly>
        </div>
        <div class="col-md-4"><label>Cash Balance</label>
          <input type="number" step="0.01" name="cash_balance" placeholder="Cash Balance" class="form-control">
        </div>
        <div class="card mb-4">
          <div class="card-header bg-success text-white">
            Cash Opening Balance
          </div>
          <div class="card-body row g-3">
        
            <div class="col-md-6">
              <label for="previous_balance" class="form-label">Previous Day Cash Balance (Auto)</label>
              <input type="number" step="0.01" id="previous_balance" name="previous_balance" 
                     value="{{ previous_day_balance }}" class="form-control" readonly>
            </div>
        
            <div class="col-md-6">
              <label for="extra_cash" class="form-label">Additional Cash in Hand (if any)</label>
              <input type="number" step="0.01" id="extra_cash" name="extra_cash" value="0" class="form-control">
            </div>
        
          </div>
        </div>
        
      </div>
    </div>
<!-- Bank Summary Section -->
<div class="card mt-4">
  <div class="card-header bg-primary text-white">
    Bank Summary
  </div>
    <table class="table table-bordered" id="bankTransactionTable">
      <thead class="table-light">
        <tr>
          <th>Type</th>
          <th>Amount (₹)</th>
          <th>Description</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="bankTransactionBody">
        <tr>
          <td>
            <select name="transaction_type" class="form-select">
              <option value="Income">Income</option>
              <option value="Expenditure">Expenditure</option>
            </select>
          </td>
          <td><input type="number" step="0.01" name="amount" class="form-control" required></td>
          <td><input type="text" name="description" class="form-control" required></td>
          <td class="text-center">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeTransactionRow(this)">Remove</button>
          </td>
        </tr>
       
          <div class="card-body row g-3">
            <div class="col-md-4">
              <label class="form-label">Total Bank Income (₹)</label>
              <input type="number" id="totalBankIncome" class="form-control" readonly>
            </div>
            <div class="col-md-4">
              <label class="form-label">Total Bank Expenditure (₹)</label>
              <input type="number" id="totalBankExpenditure" class="form-control" readonly>
            </div>
            <div class="col-md-4">
              <label class="form-label">Bank Closing Balance (₹)</label>
              <input type="number" id="bankClosingBalance" class="form-control" readonly>
            </div>
          </div>
        </div>        
      </tbody>
    </table>
    
    <!-- Button to Add Another Transaction -->
    <button type="button" class="btn btn-secondary" onclick="addTransactionRow()">Add Another Transaction</button>
    

    <!-- Credit Details Section -->
    <!-- Credit Details Section -->
<div class="card mb-4">
  <div class="card-header">Credit Details</div>
  <div class="card-body">
    <table class="table table-bordered">
      <thead class="table-light">
        <tr>
          <th>Person</th>
          <th>Previous Credit Given</th>
          <th>Today's Credit Given</th>
        </tr>
      </thead>
      <tbody>
        {% for person in credit_names %}
        <tr>
          <td>{{ person }}</td>
          <td>
            {{ previous_credit|get_item:person }}
          </td>
          <td>
            <input type="number" step="0.01" name="credit_given_{{ person|lower }}" class="form-control">
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="text-center">
    <button type="submit" id="submitBtn" class="btn btn-primary">Submit Daily Entry</button>
</div>
</form>

  <!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          Daily Entry Submitted Successfully!
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>
  
</div>
<script>
  function calculateBankSummary() {
    let incomeTotal = 0;
    let expenditureTotal = 0;
  
    let rows = document.querySelectorAll('#bankTransactionBody tr');
    rows.forEach(function(row) {
      let type = row.querySelector('select[name="transaction_type"]')?.value;
      let amount = parseFloat(row.querySelector('input[name="amount"]')?.value) || 0;
  
      if (type === "Income") {
        incomeTotal += amount;
      } else if (type === "Expenditure") {
        expenditureTotal += amount;
      }
    });
  
    document.getElementById('totalBankIncome').value = incomeTotal.toFixed(2);
    document.getElementById('totalBankExpenditure').value = expenditureTotal.toFixed(2);
    document.getElementById('bankClosingBalance').value = (incomeTotal - expenditureTotal).toFixed(2);
  }
  
  // When page loads and after any input change
  document.addEventListener('DOMContentLoaded', function() {
    setInterval(calculateBankSummary, 500);  // Recalculate every half second
  });
  </script>
  
<script>
  function addTransactionRow() {
    let table = document.getElementById("bankTransactionBody");
    let newRow = `
      <tr>
        <td>
          <select name="transaction_type" class="form-select">
            <option value="Income">Income</option>
            <option value="Expenditure">Expenditure</option>
          </select>
        </td>
        <td><input type="number" step="0.01" name="amount" class="form-control" required></td>
        <td><input type="text" name="description" class="form-control" required></td>
        <td class="text-center">
          <button type="button" class="btn btn-danger btn-sm" onclick="removeTransactionRow(this)">Remove</button>
        </td>
      </tr>
    `;
    table.insertAdjacentHTML('beforeend', newRow);
  }
  
  function removeTransactionRow(button) {
    button.closest('tr').remove();
  }
  </script>
  
<script>
  document.addEventListener('DOMContentLoaded', function() {
  
      function calculateTotals() {
          // Get Previous Cash Balance
          let previousCash = parseFloat(document.getElementById('previous_balance').value) || 0;
          let extraCash = parseFloat(document.getElementById('extra_cash').value) || 0;
  
          // Get all Income fields
          let incomeFields = [
              'sale_of_day', 'other_income', 'money_from_bank', 'credit_received', 'google_pay_income', 'black_purse', 'raajeev_income',
              'credit_paid_amila', 'credit_paid_ashwati', 'credit_paid_athira', 'credit_paid_arun', 'credit_paid_lijin', 'credit_paid_kannan'
          ];
  
          let totalIncome = previousCash + extraCash;
  
          incomeFields.forEach(function(name) {
              let input = document.getElementsByName(name)[0];
              if (input && input.value) {
                  totalIncome += parseFloat(input.value) || 0;
              }
          });
  
          // Get all Expenditure fields
          let expenditureFields = [
              'sip', 'gokulam', 'vijesh', 'raajeev_expenditure',
              'salary_amila', 'salary_ashwati', 'salary_athira', 'salary_arun', 'salary_lijin', 'salary_kannan',
              'customer_credit', 'other_expenditure', 'medicine_purchase', 'gpay_to_bank'
          ];
  
          let totalExpenditure = 0;
          expenditureFields.forEach(function(name) {
              let input = document.getElementsByName(name)[0];
              if (input && input.value) {
                  totalExpenditure += parseFloat(input.value) || 0;
              }
          });
  
          // Calculate Cash Balance
          let cashBalance = totalIncome - totalExpenditure;
  
          // Show Calculated Values
          if (document.getElementsByName('total_income')[0]) {
              document.getElementsByName('total_income')[0].value = totalIncome.toFixed(2);
          }
          if (document.getElementsByName('total_expenditure')[0]) {
              document.getElementsByName('total_expenditure')[0].value = totalExpenditure.toFixed(2);
          }
          if (document.getElementsByName('cash_balance')[0]) {
              document.getElementsByName('cash_balance')[0].value = cashBalance.toFixed(2);
          }
      }
  
      // Attach input event to all number fields
      let allInputs = document.querySelectorAll('input[type=\"number\"]');
      allInputs.forEach(function(input) {
          input.addEventListener('input', calculateTotals);
      });
  
      // Calculate once on page load
      calculateTotals();
  });
  </script>
  
      
{% endblock %}
